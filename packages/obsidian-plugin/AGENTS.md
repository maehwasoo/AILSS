# AGENTS.md (packages/obsidian-plugin)

This directory contains the **Obsidian community plugin** for AILSS.

## What it does

- Provides an in-Obsidian UI for AILSS actions (search, status, etc.)
- Spawns a local MCP stdio server process (desktop-only)
- Acts as a thin client over MCP; heavy logic should live in the MCP server / core packages

## Quick facts

- Plugin ID: `ailss-obsidian` (`packages/obsidian-plugin/manifest.json`)
- Desktop-only: spawns a local MCP stdio server process
- MCP HTTP shutdown is gated behind a separate admin token (the plugin generates and injects it into the service process).
- Build output: `main.js` (generated by esbuild; do not commit)

## Entry points

- Plugin runtime: `packages/obsidian-plugin/src/main.ts`
- Settings: `packages/obsidian-plugin/src/settings.ts`
- Build config: `packages/obsidian-plugin/esbuild.config.mjs`

## Code map (high-level)

- Indexer orchestration: `packages/obsidian-plugin/src/indexer/*`
    - Runtime wrapper: `packages/obsidian-plugin/src/indexer/indexerRunner.ts`
    - Auto-index scheduling: `packages/obsidian-plugin/src/indexer/autoIndexScheduler.ts`
    - Auto-index event wiring: `packages/obsidian-plugin/src/indexer/autoIndexEvents.ts`
    - Index DB maintenance: `packages/obsidian-plugin/src/indexer/indexDbReset.ts`
    - Failure hint mapping: `packages/obsidian-plugin/src/indexer/indexerFailureHints.ts`
    - Log snapshot file export: `packages/obsidian-plugin/src/indexer/indexerLogFile.ts`
- MCP HTTP service: `packages/obsidian-plugin/src/mcp/*`
    - Lifecycle: `packages/obsidian-plugin/src/mcp/mcpHttpServiceController.ts`
    - Search wrapper: `packages/obsidian-plugin/src/mcp/semanticSearchService.ts`
- UI helpers (keep `main.ts` thin): `packages/obsidian-plugin/src/ui/*`
    - Modal open helpers: `packages/obsidian-plugin/src/ui/pluginModals.ts`
    - Status bar mounting/rendering: `packages/obsidian-plugin/src/ui/statusBars.ts`
    - Index DB reset confirm flow: `packages/obsidian-plugin/src/ui/indexDbResetFlow.ts`
    - Notifications (Obsidian `Notice`): `packages/obsidian-plugin/src/ui/pluginNotices.ts`
- Path/arg resolution + misc utils: `packages/obsidian-plugin/src/utils/*`
    - Vault/plugin paths + child process args: `packages/obsidian-plugin/src/utils/pluginPaths.ts`
    - Prompt install (vault root): `packages/obsidian-plugin/src/utils/vaultRootPromptInstaller.ts`
    - Codex skill install/copy helpers: `packages/obsidian-plugin/src/utils/codexSkillInstaller.ts`, `packages/obsidian-plugin/src/utils/codexClipboardService.ts`, `packages/obsidian-plugin/src/utils/clipboard.ts`

## What to follow

- Treat `main.js` as build output; it should not be committed or hand-edited.
- Any vault/file edits must be behind an explicit user action (matching the repo’s “read-first” stance).
- Keep the plugin ID stable (it controls the folder name under `.obsidian/plugins/`).
- Prefer extracting UI/status-bar/modal glue into `src/ui/*` helpers instead of growing `main.ts`.

## Local testing

Obsidian loads plugins from:

- `<Vault>/.obsidian/plugins/<plugin-id>/`

For faster iteration, point Obsidian at a test vault and use a symlink so Obsidian loads the plugin straight from this folder.
Exact build/dev scripts live in `packages/obsidian-plugin/package.json`.

## Integration boundary

- Read-only recommendations/search should come from the MCP server tools.
- Any file edits must be behind an explicit user action (apply button, etc.).
