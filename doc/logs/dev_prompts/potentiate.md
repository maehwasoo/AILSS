# 포텐시에이트 모듈 개선 계획

## 개요 및 목표

포텐시에이트(Potentiate) 모듈은 노트의 강화 값(potentiation)을 관리하는 기능으로, 현재는 명령어 실행 시 단순히 강화 값을 +1 증가시키는 기능만 제공합니다. 이 모듈을 개선하여 다음 기능을 추가하고자 합니다:

- [x] 1. 노트 내용 복기를 통한 정확도 검증 기능
- [x] 2. 텍스트 또는 음성 입력 방식 지원
- [x] 3. AI를 통한 정확도 평가(75% 이상일 때만 강화 적용)

이 모든 기능은 유지보수가 쉽고, 사용자 설정을 통해 켜고 끌 수 있도록 모듈화하며, 기존 컴포넌트를 최대한 재활용하여 일관성을 유지합니다.

## 1. 모듈 구조 재구성

### 1.1 디렉토리 구조

```
src/
├── modules/
│   ├── command/
│   │   └── update/
│   │       └── potentiate.ts        # 기존 파일 리팩토링 (핵심 로직 유지)
│   │
│   └── ai/
│       └── ai_utils/
│           ├── aiUtils.ts           # 기존 AI 유틸리티 재활용
│           ├── whisperUtils.ts      # 음성 인식 기능 (신규)
│           └── accuracyChecker.ts   # 정확도 평가 서비스 (신규)
│
├── components/
│   └── potentiateUI/
│       └── noteRecallModal.ts       # 노트 복기 모달 UI
│
└── core/
    └── settings/
        └── settings.ts              # 정확도 검증 토글 추가
```

### 1.2 기존 코드 이전 및 확장

- [x] `potentiate.ts`의 핵심 강화 로직은 그대로 유지
- [x] 노트 복기 및 정확도 검증 기능을 위한 인터페이스 추가
- [x] 설정을 통해 정확도 검증 기능을 On/Off할 수 있도록 구현

## 2. 기능 구현 계획

### 2.1 노트 복기 기능

#### 기존 로직
- [x] 노트에서 명령어 실행 → 확인 모달 → 강화 값(potentiation) +1 증가

#### 개선 로직
- [x] 노트에서 명령어 실행 → 설정 확인 → (검증 활성화 시) 노트 복기 모달 → 정확도 검증 → 결과에 따른 강화 적용
- [x] 정확도 75% 이상 시에만 강화 값 +1 적용
- [x] 검증 비활성화 시 기존 로직대로 바로 강화 적용

### 2.2 정확도 검증 서비스 (accuracyChecker.ts)

- [x] 노트 내용과 사용자 입력을 비교하여 정확도 평가
- [x] `settings.ts`에 설정된 AI 모델(Claude, OpenAI 등) 활용
- [x] 정확도 계산 알고리즘: AI 모델에 두 텍스트의 유사성 평가 요청
- [x] 결과값은 0-100% 범위의 숫자로 반환

### 2.3 음성 인식 기능 (whisperUtils.ts)

- [x] 브라우저의 MediaRecorder API를 사용하여 오디오 캡처
- [x] 캡처된 오디오를 Whisper API로 전송하여 텍스트 변환
- [x] 변환된 텍스트는 노트 복기 모달의 입력창에 자동 삽입

## 3. UI 구성 상세

### 3.1 노트 복기 모달 (noteRecallModal.ts)

#### 헤더 영역
- [x] 좌측: "노트 복기" 제목 (h2 태그, 좌측 정렬)
- [x] 우측: 마이크 아이콘 버튼 + 제출 버튼 (우측 정렬)

#### 본문 영역
- [x] 텍스트 입력창 (textarea, 멀티라인 지원)
- [x] 입력창 높이는 최소 150px, 자동 확장 지원

#### 상태 표시 영역
- [x] 마이크 상태 표시 (녹음 중/대기 중)
- [x] 제출 버튼 클릭 시 "분석 중..." 상태 표시

### 3.2 동작 흐름

- [x] 1. 마이크 버튼 클릭 → 녹음 시작 → 버튼 색상 변경 (활성화 상태)
- [x] 2. 마이크 버튼 재클릭 → 녹음 종료 → Whisper API 호출
- [x] 3. 텍스트 변환 결과 → 입력창에 표시
- [x] 4. 제출 버튼 클릭 → 정확도 평가 → 결과에 따른 강화 적용/미적용

## 4. 설정 추가

### 4.1 settings.ts 파일 수정

- [x] 정확도 검증 설정 추가:
```typescript
export interface AILSSSettings {
  // 기존 설정들...
  enablePotentiateAccuracyCheck: boolean;  // 노트 강화 시 정확도 검증 활성화 여부
}

export const DEFAULT_SETTINGS: AILSSSettings = {
  // 기존 설정들...
  enablePotentiateAccuracyCheck: true,  // 기본값은 활성화
};
```

### 4.2 설정 UI 추가

- [x] 설정 탭에 "노트 강화 정확도 검증" 토글 스위치 추가
- [x] 정확도 검증을 비활성화하면 기존 강화 로직만 실행 (바로 +1)
- [x] 정확도 검증 임계값(75%)은 하드코딩으로 유지

### 4.3 하드코딩 설정 값

- [x] 정확도 임계값: 75% (하드코딩)
- [x] 강화 증가값: +1 (하드코딩)

## 5. 구현 단계

### 5.1 기본 구조 구현 (1단계)

- [x] 1. whisperUtils.ts 파일 생성 및 기본 API 연동 구현
- [x] 2. accuracyChecker.ts 파일 생성 및 기본 로직 구현
- [x] 3. settings.ts에 정확도 검증 토글 설정 추가

### 5.2 UI 구현 (2단계)

- [x] 1. noteRecallModal.ts 생성 및 UI 레이아웃 구현
- [x] 2. 마이크 녹음 기능 및 이벤트 핸들러 구현
- [x] 3. 입력 및 제출 로직 구현

### 5.3 로직 통합 (3단계)

- [x] 1. potentiate.ts 수정하여 정확도 검증 기능 연동
- [x] 2. 정확도 검증 결과에 따른 강화 적용 로직 구현
- [x] 3. 설정에 따른 로직 분기 처리 구현

### 5.4 테스트 및 개선 (4단계)

- [x] 1. 각 기능 단위 테스트
- [x] 2. 통합 테스트 및 버그 수정
- [x] 3. 사용자 피드백 반영 및 UI/UX 개선

## 6. 핵심 로직 흐름도

```
[명령어 실행] → [설정 확인]
  ↓
[정확도 검증 활성화?] → (아니오) → [즉시 강화 적용]
  ↓ (예)
[노트 복기 모달 표시]
  ↓
[텍스트 입력 또는 음성 녹음]
  ↓
[제출 버튼 클릭]
  ↓
[정확도 평가 실행]
  ↓
[정확도 ≥ 75%?] → (아니오) → [강화 미적용 + 알림]
  ↓ (예)
[강화 적용 + 알림]
```

## 7. 주요 파일 구현 계획

### 7.1 accuracyChecker.ts

- [x] 정확도 검증 인터페이스 정의
- [x] AI 모델 호출 로직 구현
- [x] 각 AI 제공업체별 처리 분기 구현

## 구현 완료 메모

포텐시에이트 모듈의 개선이 성공적으로 구현되었습니다. 주요 구현 내용은 다음과 같습니다:

1. 노트 내용 복기를 통한 정확도 검증 기능
   - 노트 내용을 기억나는 대로 텍스트로 입력하거나 음성으로 말할 수 있는 모달 UI 구현
   - 음성 입력은 OpenAI의 Whisper API를 활용하여 텍스트로 변환

2. 정확도 평가 기능
   - 사용자 설정에 따라 OpenAI, Claude, Perplexity, Google AI 등 다양한 모델 지원
   - 정확도가 75% 이상일 때만 강화 적용
   - 피드백 제공 기능 추가

3. 설정을 통한 기능 제어
   - 정확도 검증 기능을 on/off할 수 있는 설정 추가
   - 기능 비활성화 시 기존 로직으로 작동

4. 유지보수성 향상
   - 기능별 모듈화로 코드 가독성 및 유지보수성 개선
   - 기존 코드와의 통합성 유지

### 향후 개선 사항

- 마이크 녹음 시 음질 및 최대 길이 제한 설정 추가
- 정확도 평가 기준에 대한 사용자 설정 옵션 (기본값 75% 외에 조정 가능하도록)
- 오프라인 모드에서의 정확도 검증 방법 고려
- 성능 최적화 및 API 호출 최소화 방안
