name: release (plugin)

on:
  push:
    tags:
      - "plugin/v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      CI: "1"
      LEFTHOOK: "0"
      npm_config_cache: ${{ github.workspace }}/.npm-cache
      npm_config_devdir: ${{ github.workspace }}/.node-gyp

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Quality Gate
        run: pnpm check:ci

      - name: Build plugin bundle
        run: pnpm -C packages/obsidian-plugin build

      - name: Compute release metadata
        id: meta
        shell: bash
        run: |
          ref="${GITHUB_REF_NAME}"
          version="${ref#plugin/v}"
          echo "version=${version}" >> "${GITHUB_OUTPUT}"

          if [[ "${version}" == *-* ]]; then
            echo "prerelease=true" >> "${GITHUB_OUTPUT}"
          else
            echo "prerelease=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Validate version consistency
        env:
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          node -e "const fs=require('fs'); const version=process.env.VERSION; const manifest=JSON.parse(fs.readFileSync('packages/obsidian-plugin/manifest.json','utf8')); const pkg=JSON.parse(fs.readFileSync('packages/obsidian-plugin/package.json','utf8')); const versions=JSON.parse(fs.readFileSync('packages/obsidian-plugin/versions.json','utf8')); if (manifest.version!==version) {console.error('manifest.json version mismatch:', manifest.version, '!=', version); process.exit(1);} if (pkg.version!==version) {console.error('package.json version mismatch:', pkg.version, '!=', version); process.exit(1);} if (!Object.prototype.hasOwnProperty.call(versions, version)) {console.error('versions.json missing key:', version); process.exit(1);} "

      - name: Create plugin release zip
        env:
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          out="ailss-obsidian-${VERSION}.zip"
          zip -j "${out}" \
            packages/obsidian-plugin/main.js \
            packages/obsidian-plugin/manifest.json \
            packages/obsidian-plugin/styles.css \
            packages/obsidian-plugin/versions.json
          ls -la "${out}"

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: plugin v${{ steps.meta.outputs.version }}
          prerelease: ${{ steps.meta.outputs.prerelease }}
          generate_release_notes: true
          files: |
            ailss-obsidian-${{ steps.meta.outputs.version }}.zip
